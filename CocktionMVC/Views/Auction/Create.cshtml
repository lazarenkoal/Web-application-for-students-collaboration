@using CocktionMVC.Models
@using CocktionMVC.Models.DAL;
@model List<Location>
@{
    ViewBag.Title = "Создать аукцион";
}
<head>
    <script src="~/Scripts/Jquery/jquery-2.1.3.js"></script>
    <script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU" type="text/javascript"></script>
    
</head>>

<h3>Создай свой аукцион!</h3>
<div class="row">
    <div id="formContainer" class="col-lg-3">
        <p>Имя</p>
        <input type="text" id="Name" name="Name" required />
        <p>Описание</p>
        <input type="text" id="Description" name="Description" required />
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
                Выбрать категорию
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1" id="category">
                <li class="dropdown-submenu">
                    <a tabindex="-1" href="#">Электроника</a>
                    <ul class="dropdown-menu-right">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Фото и видеокамеры</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Телефоны</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Аудио и видеотехника</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Игровые приставки</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Просто очень крутая электронная штука</a></li>
                    </ul>
                </li>
                <li class="dropdown-submenu">
                    <a tabindex="-1" href="#">Компьютеры</a>
                    <ul class="dropdown-menu-right">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Аксессуары и расходники</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Комплектующие</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Накопители</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Периферийные устройства</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Игры и ПО</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Компы</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Оргтехника</a></li>
                    </ul>
                </li>
                <li class="dropdown-submenu">
                    <a tabindex="-1" href="#">Бытовая техника</a>
                    <ul class="dropdown-menu-right">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Климатическая техника</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Мелочи для кухни</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Техника для красоты</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Крупная техника для кухни</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Техника для дома</a></li>
                    </ul>
                </li>
                <li class="dropdown-submenu">
                    <a tabindex="-1" href="#">Жизненное</a>
                    <ul class="dropdown-menu-right">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Мелочи для жизни</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Всякие приколюхи</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Домашний хлам</a></li>
                    </ul>
                </li>
                <li class="dropdown-submenu">
                    <a tabindex="-1" href="#">Шмотки</a>
                    <ul class="dropdown-menu-right">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Одежда для милых дам</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Одежда для респектабельных господ</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Украшения для внешнего вида</a></li>
                    </ul>
                </li>
                <li class="dropdown-submenu">
                    <a tabindex="-1" href="#">Прочее</a>
                    <ul class="dropdown-menu-right">
                        <li role="presentation"><a role="menuitem" tabindex="-1" id="Прочее" href="#">Еда</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Напитки</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Услуги</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Люди</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Книги</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div id="info"></div>
        <p>Часов</p>
        <input type="number" min="0" id="Hours" name="Hours" required />
        <p>Минут</p>
        <input type="number" min="1" id="Minutes" name="Minutes" required />
        <p></p>
        <input type="file" id="file" />
        <input type="button" id="creator" class="btn btn-default" value="Создать аукцион" />
        <input type="button" id="createAndUploadPhotoFromMobile" class="btn btn-success" value="Загрузить фотку с телефона" />
        <div id="checkboxInfo"></div>
    </div>
    <div class="col-lg-3">
        <div id="locationForm">
            <ul>
                @foreach (var location in Model)
                {
                    <li role="presentation"><input type="checkbox" onclick="getLocationId(event)" id="@location.Id" name="locationCheckbox">@location.BaloonContent</li>
                }
            </ul>
        </div>
    </div>
    <div class="col-lg-6">
        <div id="map" style="width: 600px; height:400px"></div>
        <div id="mapInfo"></div>
    </div>
</div>

<script>
    var locationsId = new Set();
    var locCollection = new Map();
    function getLocationId(event) {
        if (event.target.checked) {
            //Если чувак поставил отметку
            var xhr = new XMLHttpRequest();
            locationData = new FormData();
            locationsId.add(event.target.id);
            locationData.append("locationId", event.target.id);
            xhr.open('POST', '/Placemark/GetCurrentPlacemark');
            xhr.send(locationData);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var location = JSON.parse(xhr.responseText);
                    myPlacemark = new ymaps.Placemark(
                    location.Coordinates,
                    {
                        iconContent: location.Baloon.IconContent,
                        balloonContent: location.Baloon.BaloonContent
                    },
                    {
                        preset: location.Options.Preset
                    }
                    );
                    myPlacemarkCollection.add(myPlacemark);
                    locCollection.set(event.target.id, myPlacemark);
                }
            };
            myMap.geoObjects.add(myPlacemarkCollection);
        }
        else {//если чувак снял отметку
            //реализовать удаление с карты 
            //locationsId.delete(event.target.id);
            //myMap.geoObjects.remove(locCollection(event.target.id));
            locCollection.delete(event.target.id);
        }
    };
</script>
<script>
    //Сделать метод, который будет собирать все чекнутые чекбоксы и отправлять их на серваке
    var myMap;
    function init() {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 12
        });
        myMap.controls.add('zoomControl', { right: '10px', top: '5px' });
        myPlacemarkCollection = new ymaps.GeoObjectCollection();
    };
    ymaps.ready(init);
    var myPlacemarkCollection;
</script>
<script>
    //достает то, на что пользователь кликнул при выборе категорий
    $(document).on('click', '.dropdown-menu li a', function () {
        $('#info').empty();
        $('#info').append($(this).text());
    });

    //Добавить верификацию данных
    $('#creator').click(function () {
        var formData = new FormData();
        var req = new XMLHttpRequest;
        formData.append("Name", $('#Name').val());
        formData.append("Description", $('#Description').val());
        formData.append("Category", $('#info').text());
        formData.append("Hours", $('#Hours').val());
        formData.append("Minutes", $('#Minutes').val());
        var locationsIdString = "!";
        locationsId.forEach(function (value) {
            locationsIdString += value + '!';
        });

        formData.append("LocationsId", locationsIdString);
        var fileInput = document.getElementById('file');
        var filename1 = fileInput.files[0].name;
        formData.append(fileInput.files[0].name, fileInput.files[0]);
        $('#formContainer').empty();
        $('#formContainer').append('<p>загрузка в процессе</p>');
        req.open("POST", "/BidAuctionCreator/CreateAuction");
        req.send(formData);
        req.onreadystatechange = function () {
            if (req.readyState == 4 && req.status == 200) {
                $('#formContainer').empty();
                $('#formContainer').append('<p>' + req.responseText + '</p>');
            }
        }
    });

    $('#createAndUploadPhotoFromMobile').click(function () {
        var formData = new FormData();
        var req = new XMLHttpRequest;
        formData.append("Name", $('#Name').val());
        formData.append("Description", $('#Description').val());
        formData.append("Category", $('#info').text());
        formData.append("Hours", $('#Hours').val());
        formData.append("Minutes", $('#Minutes').val());
        $('#formContainer').empty();
        $('#formContainer').append('<p>загрузка в процессе c мобилки</p>');
        req.open("POST", "/BidAuctionCreator/SaveProductInfo");
        req.send(formData);
        req.onreadystatechange = function () {
            if (req.readyState == 4 && req.status == 200) {
                $('#formContainer').empty();
                var respond = JSON.parse(req.responseText);
                $('#formContainer').append('<p>' + respond.Path + '</p>');
            }
        }
    });

</script>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval");
}

